name: Update 13F Holdings Data

on:
  schedule:
    # Run daily at 7 AM KST (10 PM UTC previous day)
    - cron: '0 22 * * *'
  workflow_dispatch:  # Manual trigger

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Fetch 13F data from SEC EDGAR
        run: python fetch_13f.py

      - name: Build HTML with fresh data
        run: |
          python3 -c "
          import json

          with open('data/holdings.json', 'r') as f:
              data = json.load(f)

          # Read template (keep a template version without data)
          with open('index_template.html', 'r') as f:
              html = f.read()

          json_str = json.dumps(data, ensure_ascii=False)
          html = html.replace('HOLDINGS_DATA_PLACEHOLDER', json_str)

          with open('index.html', 'w') as f:
              f.write(html)

          print('HTML built successfully')
          "

      - name: Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add data/holdings.json index.html
          git diff --staged --quiet || git commit -m "Update 13F holdings data $(date +'%Y-%m-%d')"
          git push
